- name: Monitoring
  hosts: hostservers,tgens,DPUs
  become: yes
  vars:
    bmc_vars: "{{ hostvars[inventory_hostname+'bmc'] }}"
  tasks:
    - name: Copy telegraf folder to remote
      ansible.builtin.copy: src=../telegraf.d dest=/root

    - name: Remove arista config file
      ansible.builtin.file: state=absent path=/root/telegraf.d/arista.conf

    - name: Nvidia | Additional Nvidia-specific tasks
      when: inventory_hostname == 'bf2'
      block:
        - name: Nvidia | make sure emulation is running for temperature
          ansible.builtin.systemd: state=started name=set_emu_param
        - ansible.builtin.systemd: state=stopped name=mlnx_snap
        - ansible.builtin.systemd: state=started name=spdk_tgt

    - name: Intel | Set environment and downgrade requests package
      when: inventory_hostname == 'mev'
      environment: "{{ proxy_env | default({}) }}"
      block:
        - name: Intel | Downgrade requests package due to bug https://github.com/ansible-collections/community.docker/issues/868
          ansible.builtin.pip: name=requests<2.32

    - name: Run telegraf container
      community.docker.docker_container:
        name: telegraf
        image: docker.io/library/telegraf:1.31
        state: started
        restart: true
        detach: true
        network_mode: host
        restart_policy: always
        mounts: >
          {{
            [
              {
                'type': 'bind',
                'source': inventory_hostname == 'bf2' and '/root/telegraf.d/telegraf.conf.bf2' or
                          inventory_hostname == 'mev' and '/root/telegraf.d/telegraf.conf.mev' or
                          '/root/telegraf.d',
                'target': inventory_hostname in ['bf2', 'mev'] and '/etc/telegraf/telegraf.conf' or
                          '/etc/telegraf/telegraf.d',
                'read_only': True
              }
            ]
            + (
              [
                {
                  'type': 'bind',
                  'source': '/run/emu_param',
                  'target': '/run/emu_param',
                  'read_only': True
                }
              ]
              if inventory_hostname == 'bf2' else []
            )
          }}

    - name: Run telegraf container on other hosts
      when:
        - inventory_hostname != 'mev'
        - inventory_hostname != 'bf2'
      community.docker.docker_container:
        name: telegraf
        env:
          REDFISH_HOST: "{{ bmc_vars.ansible_host }}"
          REDFISH_USER: "{{ bmc_vars.ansible_user }}"
          REDFISH_PASSWORD: "{{ bmc_vars.ansible_password }}"
          REDFISH_SYSTEM_ID: "{{ bmc_vars.resource_id }}"
